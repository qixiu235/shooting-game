<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•°å­—æ–¹å—å°„å‡»æ¸¸æˆ</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
      touch-action: none;
    }
    #info {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 20px;
      text-shadow: 0 0 5px black;
      pointer-events: none;
      z-index: 10;
    }

    /* æ¸¸æˆè§„åˆ™é¢æ¿ */
    #rules {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      background: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 24px;
      border-radius: 16px;
      font-size: 16px;
      line-height: 1.6;
      text-align: left;
      z-index: 15;
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
    }

    #rules h2 {
      margin-top: 0;
      font-size: 24px;
      text-align: center;
      color: #ffcc00;
      margin-bottom: 16px;
    }

    #rules p {
      margin: 12px 0;
    }

    #rules strong {
      color: #4fc3f7;
    }

    /* å¼€å§‹æ¸¸æˆæŒ‰é’® */
    #start-btn {
      position: absolute;
      top: calc(50% + 180px);
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 36px;
      font-size: 24px;
      background: #ff4081;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #start-btn:hover {
      background: #e91e63;
    }

    /* é‡æ–°å¼€å§‹æŒ‰é’® */
    #restart-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 16px 40px;
      font-size: 28px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: none;
      z-index: 20;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #restart-btn:hover {
      background: #45a049;
    }

    /* èƒŒæ™¯æš—åŒ–é®ç½© */
    #background-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.45);
      pointer-events: none;
      z-index: 1;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¾—åˆ† -->
  <div id="info">å¾—åˆ†: <span id="score">0</span></div>

  <!-- æ¸¸æˆè§„åˆ™è¯´æ˜ -->
  <div id="rules">
    <h2>ğŸ®ã€Šæ•°å­—æ–¹å—å°„å‡»ã€‹æ¸¸æˆè§„åˆ™</h2>
    <p><strong>ğŸ§© æ¸¸æˆç›®æ ‡</strong><br>
       å‡»ä¸­ä¸æ–­é è¿‘çš„å½©è‰²æ•°å­—æ–¹å—ï¼Œè·å–é«˜åˆ†ï¼<br>
       åœ¨æ–¹å—åˆ°è¾¾ä½ é¢å‰ä¹‹å‰ï¼Œç”¨é¼ æ ‡ï¼ˆæˆ–è§¦æ‘¸å±ï¼‰ç‚¹å‡»å®ƒä»¬ï¼Œå°†æ•°å­—ç´¯åŠ ä¸ºä½ çš„å¾—åˆ†ã€‚åšæŒè¶Šä¹…ï¼Œå¾—åˆ†è¶Šé«˜ï¼</p>

    <p><strong>ğŸ•¹ï¸ æ“ä½œæ–¹å¼</strong><br>
       â€¢ <strong>PC ç«¯</strong>ï¼šç§»åŠ¨é¼ æ ‡å¯¹å‡†æ–¹å—ï¼Œå•å‡»å·¦é”®è¿›è¡Œå°„å‡»ã€‚<br>
       â€¢ <strong>æ‰‹æœº/å¹³æ¿</strong>ï¼šç‚¹å‡»å±å¹•ä¸Šçš„æ–¹å—å³å¯å°„å‡»ã€‚<br>
       ğŸ’¡ æç¤ºï¼šæ¯æ¬¡å‡»ä¸­ä¸€ä¸ªæ–¹å—ï¼Œä¼šè·å¾—è¯¥æ–¹å—ä¸Šæ˜¾ç¤ºçš„æ•°å­—åˆ†æ•°ï¼</p>

    <p><strong>âš ï¸ æ¸¸æˆç»“æŸæ¡ä»¶</strong><br>
       ä»»æ„ä¸€ä¸ªæ–¹å—åˆ°è¾¾ç©å®¶ä½ç½®ï¼ˆå³ç©¿è¿‡å±å¹•å‰æ–¹ï¼‰ï¼Œæ¸¸æˆç«‹å³ç»“æŸã€‚<br>
       æ­¤æ—¶ä¼šæ˜¾ç¤ºä½ çš„æœ€ç»ˆå¾—åˆ†ï¼Œå¹¶å¼¹å‡ºã€é‡æ–°å¼€å§‹ã€‘æŒ‰é’®ã€‚</p>
  </div>

  <!-- æŒ‰é’® -->
  <button id="start-btn">å¼€å§‹æ¸¸æˆ</button>
  <button id="restart-btn">é‡æ–°å¼€å§‹</button>
  <div id="background-overlay"></div>

  <!-- å¼•å…¥ Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <script>
    // ======================
    // å…¨å±€å˜é‡
    // ======================
    let scene, camera, renderer, score = 0;
    let blocks = [];
    let explosions = [];
    let audioContext;
    let gameActive = false;

    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const rulesPanel = document.getElementById('rules');

    // ======================
    // éŸ³æ•ˆç³»ç»Ÿ
    // ======================
    function initAudio() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.warn("Web Audio not supported");
        }
      }
    }

    function playHitSound() {
      if (!audioContext) return;
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.2);
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.start();
      oscillator.stop(audioContext.currentTime + 0.2);
    }

    // ======================
    // ç²’å­çˆ†ç‚¸ç‰¹æ•ˆ
    // ======================
    function createExplosion(position, color) {
      const particleCount = 20;
      const particles = new THREE.Group();
      for (let i = 0; i < particleCount; i++) {
        const geometry = new THREE.SphereGeometry(0.05, 8, 8);
        const material = new THREE.MeshBasicMaterial({
          color: color,
          transparent: true,
          opacity: 0.8
        });
        const particle = new THREE.Mesh(geometry, material);
        const angle = Math.random() * Math.PI * 2;
        const speed = 0.5 + Math.random() * 1.0;
        particle.userData.velocity = new THREE.Vector3(
          Math.cos(angle) * speed,
          (Math.random() - 0.3) * speed,
          Math.sin(angle) * speed
        );
        particle.userData.life = 1.0;
        particle.position.copy(position);
        particles.add(particle);
      }
      scene.add(particles);
      explosions.push(particles);
    }

    // ======================
    // æ›´æ–°å¾—åˆ†ï¼ˆå…³é”®ä¿®å¤ï¼‰
    // ======================
    function updateScore(value) {
      score += value;
      document.getElementById('info').innerHTML = `å¾—åˆ†: <span id="score">${score}</span>`;
    }

    // ======================
    // åˆå§‹åŒ–åœºæ™¯
    // ======================
    function initScene() {
      scene = new THREE.Scene();

      // èƒŒæ™¯ï¼šç™½è‰²ç½‘æ ¼
      const textureLoader = new THREE.TextureLoader();
      const bgTexture = textureLoader.load('./img/white-grid.jpeg', () => {
        scene.background = bgTexture;
      });

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.body.appendChild(renderer.domElement);

      // å…‰ç…§
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(5, 10, 7);
      scene.add(dirLight);

      // åœ°é¢ï¼šç²‰è‰²ç½‘æ ¼
      const groundTexture = textureLoader.load('./img/pink-grid.jpg');
      groundTexture.wrapS = THREE.RepeatWrapping;
      groundTexture.wrapT = THREE.RepeatWrapping;
      groundTexture.repeat.set(4, 4);

      const groundGeo = new THREE.PlaneGeometry(40, 40);
      const groundMat = new THREE.MeshStandardMaterial({
        map: groundTexture,
        side: THREE.DoubleSide
      });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = -2;
      scene.add(ground);

      window.addEventListener('resize', onWindowResize);
    }

    // ======================
    // ç”Ÿæˆæ–¹å—
    // ======================
    function spawnBlocks(count) {
      const geometry = new THREE.BoxGeometry(1, 1, 1);
      for (let i = 0; i < count; i++) {
        const hue = Math.random();
        const material = new THREE.MeshStandardMaterial({
          color: new THREE.Color().setHSL(hue, 0.8, 0.6)
        });
        const block = new THREE.Mesh(geometry, material);
        block.position.set(
          (Math.random() - 0.5) * 20,
          0.5 + Math.random() * 2,
          -5 - Math.random() * 15
        );
        block.userData.number = Math.floor(Math.random() * 9) + 1;
        scene.add(block);
        blocks.push(block);
      }
    }

    // ======================
    // å°„å‡»é€»è¾‘
    // ======================
    function onShoot(event) {
      if (!gameActive) return;

      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(blocks);

      if (intersects.length > 0) {
        const hitBlock = intersects[0].object;
        updateScore(hitBlock.userData.number);
        playHitSound();
        createExplosion(hitBlock.position.clone(), hitBlock.material.color.clone());
        scene.remove(hitBlock);
        blocks.splice(blocks.indexOf(hitBlock), 1);
        if (blocks.length === 0) {
          spawnBlocks(5 + Math.floor(score / 20));
        }
      }
    }

    // ======================
    // çª—å£ç¼©æ”¾
    // ======================
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // ======================
    // åŠ¨ç”»å¾ªç¯
    // ======================
    function animate() {
      requestAnimationFrame(animate);

      if (!gameActive) return;

      // æ›´æ–°ç²’å­
      for (let i = explosions.length - 1; i >= 0; i--) {
        const group = explosions[i];
        let alive = false;
        group.children.forEach(particle => {
          if (particle.userData.life > 0) {
            particle.position.add(particle.userData.velocity);
            particle.userData.velocity.y -= 0.02;
            particle.userData.life -= 0.02;
            particle.material.opacity = particle.userData.life;
            alive = true;
          }
        });
        if (!alive) {
          scene.remove(group);
          explosions.splice(i, 1);
        }
      }

      // æ–¹å—ç§»åŠ¨ & æ¸¸æˆç»“æŸæ£€æµ‹
      for (let i = blocks.length - 1; i >= 0; i--) {
        const block = blocks[i];
        block.position.z += 0.008;
        block.rotation.y += 0.01;
        if (block.position.z > -2) {
          endGame();
          break;
        }
      }

      renderer.render(scene, camera);
    }

    // ======================
    // æ¸¸æˆç»“æŸ
    // ======================
    function endGame() {
      gameActive = false;
      document.getElementById('info').textContent = `æ¸¸æˆç»“æŸ! æœ€ç»ˆå¾—åˆ†: ${score}`;
      restartBtn.style.display = 'block';
    }

    // ======================
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    // ======================
    function resetGame() {
      // æ¸…ç†åœºæ™¯
      blocks.forEach(block => scene.remove(block));
      explosions.forEach(group => scene.remove(group));
      blocks = [];
      explosions = [];
      score = 0;

      // é‡ç½® UI
      document.getElementById('info').innerHTML = `å¾—åˆ†: <span id="score">0</span>`;
      restartBtn.style.display = 'none';
      startBtn.style.display = 'block';
      rulesPanel.style.display = 'block'; // æ˜¾ç¤ºè§„åˆ™
      gameActive = false;
    }

    // ======================
    // å¼€å§‹æ¸¸æˆ
    // ======================
    function startGame() {
      resetGame(); // ç¡®ä¿å¹²å‡€çŠ¶æ€
      gameActive = true;
      startBtn.style.display = 'none';
      rulesPanel.style.display = 'none'; // éšè—è§„åˆ™
      spawnBlocks(5);
    }

    // ======================
    // äº‹ä»¶ç»‘å®š
    // ======================
    startBtn.addEventListener('click', () => {
      initAudio();
      startGame();
    });

    restartBtn.addEventListener('click', () => {
      initAudio();
      startGame();
    });

    window.addEventListener('pointerdown', onShoot);

    // å¯åŠ¨åœºæ™¯
    initScene();
    animate();
  </script>
</body>
</html>